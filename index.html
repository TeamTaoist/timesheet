<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Taoist's Time Sheet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 15px;
      background-color: #f7f7f7;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    .date-switcher {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 0;
    }

    .date-switcher button {
      background: none;
      border: none;
      font-size: 1.5em;
      color: #007BFF;
      cursor: pointer;
      padding: 5px 10px;
      transition: color 0.3s;
    }

    .date-switcher button:hover {
      color: #0056b3;
    }

    .date-switcher button:disabled {
      color: #ccc;
      cursor: not-allowed;
    }

    #reporting-date {
      color: #555;
      font-size: 1.1em;
      min-width: 200px;
      text-align: center;
    }

    .member {
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .member {
      margin-bottom: 20px;
    }

    .parsed-report {
      margin-top: 15px;
      padding: 15px;
      border-top: 1px solid #eee;
    }

    .report-header {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 15px;
      margin-bottom: 20px;
      padding: 10px 15px;
      background: #f8f9fa;
      border-radius: 4px;
      font-size: 1.1em;
    }

    .report-header h2 {
      margin: 0;
      color: #555;
      font-weight: bold;
      font-size: 0.9em;
    }

    .total-time {
      color: #333;
      font-weight: bold;
      text-align: center;
      white-space: nowrap;
    }

    .header-link {
      text-align: right;
    }

    .header-link a {
      color: #007BFF;
      text-decoration: none;
    }

    .header-link a:hover {
      text-decoration: underline;
    }

    .daily-chart {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      margin: 25px 0;
      gap: 10px;
      height: 250px;
      position: relative;
      padding: 25px 10px 35px;
    }

    .daily-chart::before {
      content: '';
      position: absolute;
      left: 15px;
      right: 15px;
      bottom: 40px;
      height: 1px;
      background: #eee;
    }

    .chart-bar {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      justify-content: flex-end;
      position: relative;
      min-width: 60px;
    }

    .bar {
      width: 70%;
      background: #8BC34A;
      border-radius: 4px 4px 0 0;
      transition: height 0.3s ease;
      position: relative;
    }

    .bar-label {
      font-size: 0.85em;
      color: #666;
      text-align: center;
      position: absolute;
      width: 100%;
      bottom: -30px;
      white-space: nowrap;
    }

    .time-label {
      position: absolute;
      top: -30px;
      font-size: 0.85em;
      color: #666;
      width: 100%;
      text-align: center;
      white-space: nowrap;
    }

    .projects-list {
      margin-top: 15px;
      background: #f8f9fa;
      border-radius: 4px;
      padding: 12px;
    }

    .projects-list h4 {
      margin: 0 0 8px;
      color: #555;
      font-size: 0.9em;
      font-weight: bold;
    }

    .project-item {
      padding: 6px 10px;
      border-bottom: 1px solid #eee;
      background: white;
      border-radius: 3px;
      margin-bottom: 4px;
      font-size: 0.9em;
    }

    .project-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .projects-list {
      margin-top: 20px;
    }

    .project-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    .project-name {
      font-weight: bold;
      color: #333;
    }

    .project-time {
      float: right;
      color: #666;
    }

    .team-summary {
      background: linear-gradient(135deg, #4a90e2, #357abd);
      color: white;
      padding: 12px 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .summary-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
    }

    .team-summary h2 {
      margin: 0;
      font-size: 20px;
    }

    #team-total-time {
      font-size: 16px;
      margin: 0;
    }

    #team-total-entries {
      font-size: 14px;
      opacity: 0.9;
      margin: 0;
    }
  </style>
</head>

<body>
  <header>
    <div class="date-switcher">
      <button id="prev-week" onclick="changeWeek(-1)">←</button>
      <p id="reporting-date"></p>
      <button id="next-week" onclick="changeWeek(1)">→</button>
    </div>
  </header>

  <div class="team-summary">
    <div class="summary-content">
      <h2>Team Summary</h2>
      <div id="team-total-time"></div>
      <div id="team-total-entries"></div>
    </div>
  </div>
  <div id="members-container"></div>

  <script>
    // Global variables
    let currentStartDate;
    let currentEndDate;
    const teamMembers = [
      { name: 'wendy', token: '67a50b380d282255819e8adb' },
      { name: 'soul', token: '67a50b800d282255819e8be0' },
      { name: 'frozen', token: '67a50baab14f523e598a70d4' },
      { name: 'hzmangel', token: '67a7f4860d18201ebf282496' },
      { name: 'noah', token: '67a6f9e7818f8361f1596137' },
    ];

    // Helper function to format time
    function formatTime(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;
      return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
    }

    // Helper function to get max time from chart data
    function getMaxTime(chartData) {
      return Math.max(...chartData.map(item => item.totalTime));
    }

    // Function to change week
    function changeWeek(offset) {
      const newStart = new Date(currentStartDate);
      newStart.setDate(newStart.getDate() + (offset * 7));
      currentStartDate = newStart;

      const newEnd = new Date(newStart);
      newEnd.setDate(newStart.getDate() + 6);
      currentEndDate = newEnd;

      // Update the next week button (disable if it would go into the future)
      const today = new Date();
      document.getElementById('next-week').disabled = newEnd > today;

      // Update reports
      updateReports();
    }

    // Global variables for team summary
    let teamTotalTime = 0;
    let teamTotalEntries = 0;

    // Function to update team summary
    function updateTeamSummary() {
      document.getElementById('team-total-time').innerText = `Total Time: ${formatTime(teamTotalTime)}`;
      document.getElementById('team-total-entries').innerText = `Total Entries: ${teamTotalEntries}`;
    }

    // Function to update all reports
    function updateReports() {
      // Reset team totals
      teamTotalTime = 0;
      teamTotalEntries = 0;

      // Format dates for API
      const startStr = currentStartDate.toISOString().split('.')[0] + '.000Z';
      const endStr = currentEndDate.toISOString().split('.')[0] + '.999Z';

      // Update reporting date text
      document.getElementById('reporting-date').innerText =
        currentStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) +
        ' - ' +
        currentEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

      // Clear and recreate member divs
      const membersContainer = document.getElementById('members-container');
      membersContainer.innerHTML = '';

      // Create and update reports for each team member
      const promises = teamMembers.map(member => {
        const memberDiv = document.createElement('div');
        memberDiv.className = 'member';

        const parsedDiv = document.createElement('div');
        parsedDiv.id = `${member.name}-parsed`;

        memberDiv.appendChild(parsedDiv);
        membersContainer.appendChild(memberDiv);

        return renderTimeReport(member.token, parsedDiv.id, startStr, endStr);
      });

      // Update team summary after all reports are loaded
      Promise.all(promises).then(() => {
        updateTeamSummary();
      });
    }

    // Function to render time report
    async function renderTimeReport(token, elementId, startStr, endStr) {
      try {
        let memberTime = 0;
        let memberEntries = 0;
        const response = await fetch('https://reports.api.clockify.me/shared/' + token + '?page=&pageSize=&dateRangeStart=' + startStr + '&dateRangeEnd=' + endStr + '&sortOrder=&sortColumn=');
        const data = await response.json();
        let html = '<div class="parsed-report">';

        // Report Header with Title, Total Time, and Link
        const memberName = elementId.split('-')[0].charAt(0).toUpperCase() + elementId.split('-')[0].slice(1);
        const memberToken = teamMembers.find(m => m.name === memberName.toLowerCase()).token;

        html += '<div class="report-header">';
        html += `<h2>${memberName}'s Time Sheet</h2>`;
        if (data.totals && data.totals.length > 0) {
          const tot = data.totals[0];
          memberTime = tot.totalTime;
          memberEntries = tot.entriesCount;
          teamTotalTime += tot.totalTime;
          teamTotalEntries += tot.entriesCount;
          html += `<div class="total-time">${formatTime(tot.totalTime)} (${tot.entriesCount} entries)</div>`;
        } else {
          html += '<div class="total-time">00:00:00 (0 entries)</div>';
        }
        html += `<div class="header-link"><a href="https://app.clockify.me/shared/${memberToken}" target="_blank">Open Clockify</a></div>`;
        html += '</div>';

        // Chart Data
        if (data.chart) {
          const maxTime = getMaxTime(data.chart);
          html += '<div class="daily-chart">';

          // Create a map of existing data
          const timeMap = new Map(data.chart.map(item => [item._id, item.totalTime]));

          // Generate all dates in the range
          const start = new Date(currentStartDate);
          const end = new Date(currentEndDate);
          const dates = [];
          for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            const dateStr = d.toISOString().split('T')[0];
            dates.push({
              _id: dateStr,
              totalTime: timeMap.get(dateStr) || 0
            });
          }

          // Render all dates
          dates.forEach(item => {
            const height = item.totalTime ? Math.max((item.totalTime / maxTime) * 200, 20) : 20; // minimum height of 20px
            const date = new Date(item._id).toLocaleDateString('en-US', { weekday: 'short', day: 'numeric' });
            html += `
              <div class="chart-bar">
                <div class="time-label">${formatTime(item.totalTime)}</div>
                <div class="bar" style="height: ${height}px; ${item.totalTime === 0 ? 'background: #e0e0e0;' : ''}"></div>
                <div class="bar-label">${date}</div>
              </div>`;
          });
          html += '</div>';
        }

        // Group One Projects
        if (data.groupOne) {
          html += '<div class="projects-list"><h4>Projects</h4>';
          data.groupOne.forEach(project => {
            html += `<div class="project-item">${project.name} <span style="color:#666">${formatTime(project.duration)}</span></div>`;
          });
          html += '</div>';
        }

        html += '</div>';
        document.getElementById(elementId).innerHTML = html;
      } catch (error) {
        console.error('Error:', error);
        document.getElementById(elementId).innerHTML = '<p>Error loading report data.</p>';
      }
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', function () {
      // Get current date
      const now = new Date();

      // Calculate start of reporting week (Wednesday)
      const dayOfWeek = now.getDay(); // 0 is Sunday, 3 is Wednesday
      const delta = dayOfWeek >= 3 ? dayOfWeek - 3 : dayOfWeek + 7 - 3;
      const startDate = new Date(now);
      startDate.setDate(now.getDate() - delta);
      startDate.setHours(0, 0, 0, 0);

      // End date is start plus 6 days (Tuesday)
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6);
      endDate.setHours(23, 59, 59, 999);

      // Set global dates
      currentStartDate = startDate;
      currentEndDate = endDate;

      // Disable next week button initially
      document.getElementById('next-week').disabled = true;

      // Initial report update
      updateReports();
    });
  </script>

</body>

</html>
